#version=DEVEL
# System authorization information
auth --enableshadow --passalgo=sha512

# Root password
rootpw --iscrypted $6$QOf5hmc54aLRo3t/$yPOJuOPnqw3oNEP55cnYoOFvXl0R8BGDxRQEdVcKOJ.g01CfTLG0oOoqSjdCkx8ciptE.brVlLgLr7u6JnTfK.

# Use network installation
url --url="http://{{ reposerver_ip }}/dvd/"

# Use text mode install
text

# Run the Setup Agent on first boot
firstboot --enable
ignoredisk --only-use=vda

# Keyboard layouts
keyboard --vckeymap=jp106 --xlayouts='jp'

# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=eth0 --ipv6=auto --activate

# Do not configure the X Window System
skipx

# System timezone
timezone Asia/Tokyo --isUtc

# System bootloader configuration
bootloader --location=mbr --boot-drive=vda

# Partition clearing information
clearpart --all --initlabel --drives=vda
part / --fstype="xfs" --ondisk=vda --size=1 --grow

poweroff

%packages
@core

%end

%addon com_redhat_kdump --disable --reserve-mb='auto'

%end

%post --log=/root/ks-post.log
mkdir /root/.ssh
chmod -R 700 /root/.ssh
echo "{{ ansible_key_pub }}" >> /root/.ssh/authorized_keys
restorecon -Rvv /root/.ssh/

systemctl disable NetworkManager
systemctl stop NetworkManager
systemctl enable network
systemctl start network

cat << EOF > /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
NM_CONTROLLED=no
ONBOOT=yes
TYPE=Ethernet
BOOTPROTO=none
IPADDR="{{ item['ip'] }}"
PREFIX=24
GATEWAY="{{ gateway}}"
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
ARPCHECK=no
DNS1="{{ dns_server }}"
EOF

%end