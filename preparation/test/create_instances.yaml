- name: create vms for openstack
  hosts: kvm_test_host
  vars:
    reposerver_ip: 157.1.141.28
    ansible_key_pub: "{{ lookup('file', 'ansible_key.pub') }}"
    rdo_hosts:
      - { "host": "rdo-cc",      "ip": "192.168.100.100" }
      - { "host": "rdo-compute1","ip": "192.168.100.101" }
      - { "host": "rdo-compute2","ip": "192.168.100.102" }
    gateway: 192.168.100.254
    dns_server: 192.168.100.254

  tasks:
  - name: cleanup existing vms
    shell: |
      virsh destroy  test-{{ item["host"] }}
      sleep 3
      virsh undefine test-{{ item["host"] }} --remove-all-storage
      sleep 3
      exit 0
    with_items: "{{ rdo_hosts }}"

  - name: The preparation /tmp/simple-cent7-ks-xxx.cfg before creating vms
    template: src=simple-centos7-ks.cfg dest=/tmp/simple-centos7-ks-{{ item["host"] }}.cfg
    when:
      - reposerver_ip is defined
      - ansible_key_pub is defined
      - gateway is defined
      - dns_server is defined
      - item["ip"] is defined
    with_items: "{{ rdo_hosts }}"

#  - name: create vms
#    shell: |
#      qemu-img create -f qcow2 /var/lib/libvirt/images/test-"{{ item['host'] }}".qcow2 100G
# 
#      virt-install \
#      --name=test-"{{ item['host'] }}" \
#      --virt-type kvm --hvm \
#      --accelerate \
#      --nographics --noautoconsole \
#      --vcpus=2 \
#      --ram=8192 \
#      --disk /var/lib/libvirt/images/test-"{{ item['host'] }}".qcow2,format=qcow2 \
#      --network network=default \
#      --location=http://{{ reposerver_ip }}/dvd/ \
#      --initrd-inject simple-centos7-ks-"{{ item['host'] }}".cfg \
#      --extra-args='inst.ks=file:/simple-centos7-ks-{{ item["host"] }}.cfg console=tty0 console=ttyS0,115200n8 serial'
#    args:
#      chdir: /tmp
#    with_items:  "{{ rdo_hosts }}"
# 
#  - name: waiting to finish install
#    shell: |
#      RET=0
#      while [ "$RET" = "0" ]
#      do
#         virsh list | grep test-rdo
#         RET=$?
#         sleep 5
#      done
