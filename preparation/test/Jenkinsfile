import hudson.model.*

node {
  // The last stage cleans up the local images and workspace
  stage('Housekeeping') {
    deleteDir()
  }

  // The first stage checks out the code from Github
  stage('Get Code') {
    checkout scm
  }


  // Set dir
  dir('preparation/test') {

    // Creating instances
    stage('Build Virtual Machines') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -s --private-key=ansible_key create_instances.yaml'
    }

    // Pre-configuration
    stage('Preparation Stage') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key pre-configuration.yaml'
    }

    // Reboot and wait
    stage('Reboot all nodes') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key reboot.yaml'
    }

    // Pre-testing
    stage('Pre-testing') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key test-pre-configurations.yaml'
    }

    // setup openstack
    stage('setup openstack') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key configuration-openstack.yaml'
    }

    // Test openstack installation and configuration
    stage('setup openstack') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key test-openstack.yaml'
    }

    // Reboot and wait
    stage('Reboot all nodes') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key reboot.yaml'
    }

    // Test openstack configuration
    stage('OpenStack testing') {
      sh 'chmod 600 ansible_key'
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key test-openstack-configurations.yaml'
    }

  }
}
