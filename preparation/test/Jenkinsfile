import hudson.model.*

node {
  // The last stage cleans up the local images and workspace
  stage('Housekeeping') {
    deleteDir()
  }

  // The first stage checks out the code from Github
  stage('Get Code') {
    checkout scm
  }


  // Set dir
  dir('preparation/test') {

    // Preparation
    stage('Key permission') {
      sh 'chmod 600 ansible_key'
    }

    // Creating instances
    stage('Build Virtual Machines') {
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -s --private-key=ansible_key create_instances.yaml'
    }


    // Pre-configuration
    stage('Preparation Stage') {
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key pre-configuration.yaml'
    }

    // Reboot and wait
    stage('Reboot all nodes') {
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key reboot.yaml'
    }

    // Pre-testing
    stage('Pre-testing') {
      sh 'ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -vvv -i etc/ansible_hosts -u root --private-key=ansible_key test-pre-configurations.yaml'
    }

  }
}
