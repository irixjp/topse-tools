- name: create vms for openstack
  hosts: kvm_test_host
  vars:
    reposerver_ip: 157.1.141.28
    ansible_key_pub: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC0//ez/Kt4Qt7DlDXcALgCNbPj6zxZQ+DMfHHWgE2WBvrmn392pGTjsCium5iSkjWIQW696i0aee1h3M8QfNghreX96iSl8FDhzcg3Sm67Vfi2LRWhaC60eBtIyWz9KC4orIZoWYlBX1trhm5ekpZ+GWdptqMvMOkQN3NUGbtZ+3OWCy19K1BeyVzJicdbVSW5gyvm6fHIMhaxo92+bq+nf2SePU12pPQWvtcrf6B/4s1bcrkEO1r2aVlA6t+qKo4e5DmnU2xe0Jo540LsykytemAUj3e137BTz7cXT1XbGg0CguRsfhj5lQ36M2WEaMRV6EAL76Cao1ZKVODheYHX t-nakajima@mbp2016.local"

  tasks:
  - name: cleanup existing vms
    shell: |
      virsh destroy test-rdo-cc
      virsh destroy test-rdo-compute1
      virsh destroy test-rdo-compute2
      sleep 3
      virsh undefine test-rdo-cc --remove-all-storage
      virsh undefine test-rdo-compute1 --remove-all-storage
      virsh undefine test-rdo-compute2 --remove-all-storage
      sleep 3
      exit 0
    args:
      removes: /var/lib/libvirt/images/test-rdo-cc.qcow2

  - name: The preparation /tmp/simple-cent7.cfg before creating vms
    template: src=simple-centos7-ks.cfg dest=/tmp/simple-centos7-ks.cfg
    when:
      - reposerver_ip is defined
      - ansible_key_pub is defined

  - name: create vms
    shell: |
      qemu-img create -f qcow2 /var/lib/libvirt/images/test-rdo-cc.qcow2 100G
      qemu-img create -f qcow2 /var/lib/libvirt/images/test-rdo-compute1.qcow2 100G
      qemu-img create -f qcow2 /var/lib/libvirt/images/test-rdo-compute2.qcow2 100G

      virt-install \
      --name=test-rdo-cc \
      --virt-type kvm --hvm \
      --accelerate \
      --nographics --noautoconsole \
      --vcpus=2 \
      --ram=8192 \
      --disk /var/lib/libvirt/images/test-rdo-cc.qcow2,format=qcow2 \
      --network network=default \
      --location=http://{{ reposerver_ip }}/dvd/ \
      --initrd-inject simple-centos7-ks.cfg \
      --extra-args='inst.ks=file:/simple-centos7-ks.cfg console=tty0 console=ttyS0,115200n8 serial'

      virt-install \
      --name=test-rdo-compute1 \
      --virt-type kvm --hvm \
      --accelerate \
      --nographics --noautoconsole \
      --vcpus=2 \
      --ram=8192 \
      --disk /var/lib/libvirt/images/test-rdo-compute1.qcow2,format=qcow2 \
      --network network=default \
      --location=http://{{ reposerver_ip }}/dvd/ \
      --initrd-inject simple-centos7-ks.cfg \
      --extra-args='inst.ks=file:/simple-centos7-ks.cfg console=tty0 console=ttyS0,115200n8 serial'

      virt-install \
      --name=test-rdo-compute2 \
      --virt-type kvm --hvm \
      --accelerate \
      --nographics --noautoconsole \
      --vcpus=2 \
      --ram=8192 \
      --disk /var/lib/libvirt/images/test-rdo-compute2.qcow2,format=qcow2 \
      --network network=default \
      --location=http://{{ reposerver_ip }}/dvd/ \
      --initrd-inject simple-centos7-ks.cfg \
      --extra-args='inst.ks=file:/simple-centos7-ks.cfg console=tty0 console=ttyS0,115200n8 serial'
    args:
      chdir: /tmp

  - name: waiting to finish install
    shell: |
      RET=0
      while [ "$RET" = "0" ]
      do
         virsh list | grep test-rdo
         RET=$?
         echo -n "#"
         sleep 5
      done
