- name: retrieve vms ips
  hosts: kvm_test_host
  vars:
    reposerver_ip: 157.1.141.28
    virtbrif: /var/lib/libvirt/dnsmasq/virbr0.status

  tasks:
  - name: waiting to finish install
    shell: |
      RET=0
      while [ "$RET" = "0" ]
      do
         virsh list | grep test-rdo
         RET=$?
         echo "waiting to finish install ..."
         sleep 1
      done

  - name: copy keypair.pub to KVM server
    copy:
      src: ansible_key.pub
      dest: /tmp/ansible_key.pub
      owner: root
      group: root
      mode: 0644

  - name: add keypair.pub to instances
    shell: |
      virt-customize -d test-rdo-cc       --ssh-inject root:file:/tmp/ansible_key.pub
      virt-customize -d test-rdo-compute1 --ssh-inject root:file:/tmp/ansible_key.pub
      virt-customize -d test-rdo-compute2 --ssh-inject root:file:/tmp/ansible_key.pub

  - name: start instances
    shell: |
      virsh start test-rdo-cc
      virsh start test-rdo-compute1
      virsh start test-rdo-compute2

  - name: retrieve ips
    shell: |
      cat '{{ virtbrif }}'
    register: vms_ips

  - name: add host to inventory
    add_host:
      name: '{{ item["ip-address"] }}'
      group: openstack-all
    with_items: "{{ vms_ips.stdout }}"

- name: waiting to boot instances
  hosts: openstack-all
  gather_facts: False
  tasks:

  - name: wait insntace boot
    wait_for:
      host: '{{ inventory_hostname }}'
      port: 22
      state: started
      delay: 30

  - name: ping
    ping:

